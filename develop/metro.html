<!DOCTYPE html>
<html lang="zh-TW">
<head>
@@include('include/head.html')
</head>
<body>
<div id="main">
  <div id="left">
    @@include('include/left.html')
  </div>
  <div id="top">
    @@include('include/top.html')
  </div>
  <div id="center">
    @@include('include/center.html')
  </div>
  <div id="bottom">
    @@include('include/bottom.html')
  </div>
  <div id="right">
    @@include('include/right.html')
  </div>
</div>
<script>
var vm = new Vue({
  el: '#main',
  data: {
    blueprint : [],
    index : [],
    index_blueprint: 0,
    index_line: 0 ,
    index_metro : 0 ,
    key_metro : "",
    action : "",
    info : []
  },firebase: {
    
  },computed: {
   line : function(){//載入line
     if(this.blueprint.length==0)return false; //藍圖如果不存在離開
     return this.get_blueprint().line;
   },
   line_name : function(){
     if(this.blueprint.length==0)return ""; //藍圖如果不存在離開
     return this.get_line().name;
   },
   metro : function(){//載入metro
     if(this.blueprint.length==0)return false; //藍圖如果不存在離開
     return this.get_line().metro;
   },
   metro_name : function(){
     if(this.blueprint.length==0)return ""; //藍圖如果不存在離開
     return vm.get_line().metro[vm.index_metro].name;
   }
  },watch: {
    index_blueprint : function(){
      for(var i=0;i<this.index.length;i++){
        this.index[i].check=undefined;
      }
      this.index[this.index_blueprint].check=true;
    },index_line : function(){
      var index_array=vm.get_index_blueprint();
      for(var i=0;i<index_array.length;i++){
        index_array[i].check=undefined;
      }
      index_array[this.index_line].check=true;
    },key_metro : function(){
      vm.$bindAsArray('info',D.ref("info/"+user.uid+"/"+vm.key_metro));
      var _index= this.index[this.index_blueprint][this.index_line];
      _index._key=this.key_metro;
    }
  },methods: {
    更新藍圖 :function (key,data){
      if(key==undefined || data==undefined){
        data=vm.get_blueprint();
        key=data.key;
      }
       D.ref('users/' + user.uid +"/"+key).update(data);
    },
    update_line_index : function(index_array){
      var _index=0;
      for(var i=0;i<index_array.length;i++){
        if(index_array[i].check){
          _index=i;
          break;
        }
      }
      this.index_line=_index;
    },update_metro_index : function(index_array){
      var _metro=this.get_line().metro;
      if(index_array._key){//代表有選到的結點
        for(var i=0;i<_metro.length;i++){
          if(_metro[i]._key==index_array._key){
            vm.key_metro=_metro[i]._key
            break;
          }
        }
      }else{//使用預設
        vm.key_metro=_metro[0]._key;
      }
    },new_blueprint : function(){//新增藍圖
      vm.action="new_blueprint"
      var newRef=D.ref('users/' + user.uid).push();
      newRef.set({
        name: "未命名",
        line : line_template()
      })
    },delete_blueprint : function (key,index){//刪除藍圖
      vm.index.splice(index,1);
      D.ref('users/' + user.uid+"/"+key).remove();
    },exchange_blueprint : function(index,target){
      var _event=event;
      if($("html").hasClass("re_name")){//解決編輯按兩下的BUG
        return setTimeout(function(){
          _eb();
        },0);
      }
      _eb();
      function _eb(){
        if(_event && _event.target){
          if(_event.target.className!=undefined){
            if(_event.target.className.indexOf("blueprint_a")>-1 || _event.target.className.indexOf("blueprint_i")>-1){
              target=true;
            }
          }
        }
        if(target){
          vm.index_blueprint=index;
          vm.update_line_index(vm.index[index]);
          vm.update_metro_index(vm.index[index][vm.index_line]);
        }
      }
    },get_blueprint : function(index){
      if(index!=undefined)return this.blueprint[index];
      return this.blueprint[this.index_blueprint];
    },get_index_blueprint : function(){
      return vm.index[vm.index_blueprint];
    },re_name : function(index,_level){
      $("html").addClass("re_name");
      var $level_list=$(event.target).closest("."+_level+"_list");
      $level_list.addClass("edit");
      sortable[_level].option("disabled", true);
      var _name=get_level().name;
      var $level_list_input=$level_list.find("."+_level+"_input");
      $level_list_input.select().on("keyup."+_level+"_input",function(event){
        if(event.which==13){
          edit_set();
          vm.更新藍圖();
        }else if(event.which==27){
          edit_set();
          get_level().name=_name;
        }
      })
      setTimeout(function(){
        $(document).on("click."+_level+"_input",function(event){
          if(event.target.className.indexOf(""+_level+"_input")==-1){
            edit_set();
            get_level().name=_name;
          };
        })
      },5);
      function get_level(){
        if(_level=="blueprint"){
          return vm.blueprint[index];
        }else if(_level=="line"){
          return vm.get_blueprint().line[index];
        }else if(_level=="metro"){
          return vm.get_line().metro[index];
        }
      }
      function edit_set(){
       $(document).one("click",function(){//解決出現Chrome英文翻譯的問題
         $("html").removeClass("re_name");
       })
        $level_list.removeClass("edit");
        sortable[_level].option("disabled", false);
        $level_list_input.off("keyup."+_level+"_input");
        $(document).off("click."+_level+"_input");
      }
    },check_blueprint : function(index){
      if(this.index_blueprint==index){
        return "check";
      }
    },exchange_line : function(index){
      if($("html").hasClass("re_name")){//解決編輯按兩下的BUG
        return setTimeout(function(){
          _el();
        },0)
      }
      _el();
      function _el(){
        vm.index_line=index;
        vm.update_metro_index(vm.get_index_blueprint()[index]);
      }

    },get_line : function(){
      var _blueprint=this.get_blueprint();
      if(_blueprint.line){
        return _blueprint.line[this.index_line];
      }else{
        return []; //沒有資料先用這個以防出錯
      }
    },get_index_line : function(){
      return vm.index[vm.index_blueprint][vm.index_line];
    },check_line : function(index){
       if(this.index_line==index){
        return "check";
      }
    },new_line : function(){
      vm.action="new_line";
      var data=this.get_blueprint();
      if(!data.line)data.line=[];//如果沒有line就新增一個空陣列
      var get_color= vm.get_default_color( data.line.length+1);
      var _j=line_json("未命名",get_color);
      _j.metro.push(metro_json("總站"));
      data.line.push(_j);
      vm.get_index_blueprint().push([]);
      this.更新藍圖(data.key,data);
    },delete_line : function(index){
      var data=this.get_blueprint();
      data.line.splice(index,1);
      vm.get_index_blueprint().splice(index,1);
      this.更新藍圖(data.key,data);
    },new_metro : function (order){
      var _metro=metro_json("未命名");
      var data=JSON.parse(JSON.stringify(this.get_blueprint()));//將傳址改為傳值
      data.line[vm.index_line].metro.splice(order,0,_metro);
      this.更新藍圖(data.key,data);
    },check_metro : function(key,index){
      if(vm.key_metro==key){
        var _color=this.get_line().color;
        vm.index_metro=index;
        return "background-color: "+_color;
      }
    },exchange_metro : function(key){
      this.key_metro=key;
    },delete_metro : function(index){
      var data=JSON.parse(JSON.stringify(this.get_blueprint()));//將傳址改為傳值
      var old_metro_key=data.line[this.index_line].metro[index]._key;
      data.line[this.index_line].metro.splice(index,1);
      if(this.key_metro==old_metro_key){//代表刪到選取的站
        if(data.line[this.index_line].metro.length==0)return
        var _index=index-1;
        if(_index<0)_index=0;
        var new_metro_key=data.line[this.index_line].metro[_index]._key;
        this.key_metro=new_metro_key;
        vm.get_index_line().metro=new_metro_key;
      }
      this.更新藍圖(data.key,data);
    },get_default_color : function(k){
      if(k==1){
        return "#f2711c";
      }else if(k==2){
        return "#db2828";
      }else if(k==3){
        return "#fbbd08";
      }else if(k==4){
        return "#b5cc18";
      }else if(k==5){
        return "#21ba45";
      }else if(k==6){
        return "#00b5ad";
      }else if(k==7){
        return "#2185d0";
      }else if(k==8){
        return "#5829bb";
      }else if(k==9){
        return "#a333c8";
      }else if(k==10){
        return "#e03997";
      }else if(k==12){
        return "#a5673f";
      }else if(k==13){
        return "#767676";
      }else{
        return "#000000";
      }
    },open_color : function(index,color){
      color=color.split("#")[1];
      var $et=$(event.target);
      var _left=$et.offset().left;
      var _top=$et.offset().top + $et.height()+2;
      
      $("#left_color").css({
        "left" : _left,
        "top" : _top
      }).colpickSetColor(color).colpickShow();
      $(".colpick_submit").off("click.op").on("click.op",function(){
        vm.get_blueprint().line[index].color="#"+$("#left_color").val();
        vm.更新藍圖();
        $(this).off("click.op");
      });
    },new_info : function(){
      var _data ={
         message : $("#board_textarea").val() ,
         favorite : false 
//          screenshot : "" ,
//          title : "home" ,
//          href : "" ,
//          add_date :"" ,
//          icon : "https://www.google.com/s2/favicons?domain_url=http://www.eztravel.com.tw"
      }
      $("#board_textarea").val("");
      D.ref('info/' + user.uid + "/"+ vm.key_metro).push(_data);
    },delete_info : function(key){
      D.ref('info/' + user.uid + "/"+ vm.key_metro).child(key).remove();
    }
  }
})

function _is_login(){//程式進入點
  blueprint_init(function(){
    $(".blueprint_list").dropdown("destroy").dropdown({
       on : 'customClick'
     });
    $(".blueprint_list").off("contextmenu.custom").on("contextmenu.custom",function(event){
      event.preventDefault();
      if(event.target.nodeName=="INPUT"){
        return
      }
      $(this).trigger("customClick");
    })
  });
}
// $(document).bind('selectstart',function(){return false;})
</script>

<script src="src/build/js/main.js"></script>
</body>
</html>