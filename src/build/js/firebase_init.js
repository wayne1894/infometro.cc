function email_註冊(e,n,i){firebase.auth().createUserWithEmailAndPassword(e,n).then(function(e){初始化使用者資訊(i)}).catch(function(e){var n=(e.code,e.message);print(n)})}function email_登入(e,n,i){firebase.auth().signInWithEmailAndPassword(e,n).then(function(e){i()}).catch(function(e){var n=(e.code,e.message);print(n+"___")})}function 登出(){firebase.auth().signOut().then(function(){print("User sign out!"),window.location.href="/"},function(e){print("User sign out error!")})}function fb_登入(e){firebase.auth().signInWithPopup(provider).then(function(n){var i=n.user;DB.ref("users/"+i.uid).once("value",function(n){n.val()?e():初始化使用者資訊(e)})}).catch(function(e){var n=(e.code,e.message,e.email),i=e.credential;"auth/account-exists-with-different-credential"===e.code&&firebase.auth().fetchProvidersForEmail(n).then(function(e){if("password"===e[0]){var t=prompt("請輸入email密碼與facebook帳戶綁定");firebase.auth().signInWithEmailAndPassword(n,t).then(function(e){e.link(i)}).then(function(){print("成功連結")})}})})}function anonymous_login(e){firebase.auth().signInAnonymously().catch(function(e){e.code,e.message})}function 初始化使用者資訊(e){var n=firebase.auth().currentUser;DB.ref("users/"+n.uid).set({name:n.displayName,url_name:"",photo:n.photoURL}).then(e)}function blueprint_json(e){return{name:e,line:[]}}function set_line_root(e,n){DB.ref("info/"+e+"/root").set(n)}function push_line_public(e,n,i){DB.ref("info/"+e+"/public").set(!0),DB.ref("info/"+e+"/w_metro").set(!0),DB.ref("info/"+e+"/w_info").set(!0),DB.ref("info/"+e+"/line_data").set(n),DB.ref("info/"+e+"/metro_data/").set(i)}function push_now_line(){var e=vm.get_blueprint(),n=vm.get_line();n.public=!0,vm.更新藍圖(e.key,e);var i=n.metro,t=JSON.parse(JSON.stringify(n));delete t.metro,push_line_public(t._key,t,i)}function copy_public_line(e){for(var n=vm.get_blueprint(),i=0;i<n.line.length;i++)if(n.line[i]._key==e)return"repeat";DB.ref("info/"+e+"/line_data").once("value",function(i){n.line.push(i.val()),DB.ref("info/"+e+"/metro_data").once("value",function(e){n.line[n.line.length-1].metro=e.val(),n.line.public=!0,vm.更新藍圖(n.key,n)})})}function update_public_line(e){for(var n,i=vm.get_blueprint(),t=0;t<i.line.length;t++)i.line[t]._key==e&&(n=t);return void 0!=n&&void DB.ref("info/"+e+"/line_data").once("value",function(t){i.line[n]=t.val(),DB.ref("info/"+e+"/metro_data").once("value",function(e){i.line[n].metro=e.val(),vm.更新藍圖(i.key,i)})})}function line_json(e,n,i){var t=DB.ref("blueprint/"+user_uid).push().key;return set_line_root(t,user_uid+"(build)"),i||(i=!1),{_key:t,name:e,master:i,color:n,metro:[]}}function metro_json(e){return{_key:DB.ref("blueprint/"+user_uid).push().key,name:e,timestamp:firebase.database.ServerValue.TIMESTAMP}}function get_other_user(e,n){DB.ref("users/"+e).once("value",function(e){e.val()&&n(e.val())})}function blueprint_init(e){DB.ref("blueprint/"+user_uid).on("value",function(n){var i=[];if(n.forEach(function(e){i.push(e.val()),i[i.length-1].key=e.key}),0==i.length)return void vm.new_blueprint();vm.blueprint=i;for(var t=[],o=0;o<i.length;o++)if(t.push([]),i[o].line)for(var r=0;r<i[o].line.length;r++)t[o].push([]),t[o][t[o].length-1].check=!1;$.extend(t,vm.index),vm.index=t;var u=vm.index_blueprint,a=vm.action;"new_blueprint"==a?(u=vm.index.length-1,vm.exchange_blueprint(u,!0)):"new_line"==a?(vm.index_update(),vm.exchange_line(vm.index[u].length-1)):"swap_list"==a?vm.index_update():"delete_blueprint"==a?(vm.index_update(),vm.exchange_blueprint(u,!0)):"load"==a&&vm.exchange_blueprint(u,!0),"function"==typeof e&&setTimeout(e,5),vm.action="",vm.blueprint=i})}function _is_login(){DB.ref("users/"+user_uid).once("value",function(e){e.val()?vm.users=e.val():location.href="/"}),DB.ref("users_data/"+user_uid).once("value",function(e){e.val()&&e.val().index&&(vm.index=e.val().index,delete e.val().index)}).then(function(){void 0!=$.cookie("index_blueprint")&&(vm.index_blueprint=$.cookie("index_blueprint")),blueprint_init(function(){$(".blueprint_list").dropdown("destroy").dropdown({on:"customClick"}),$(".blueprint_list .blueprint_i").off("click.custom").on("click.custom",function(e){$(this).trigger("customClick")})})})}var config={apiKey:"AIzaSyAalJEx21SpnVU5q5lW0eTSVPTz18s2Hy8",authDomain:"infometro-cc.firebaseapp.com",databaseURL:"https://infometro-cc.firebaseio.com",storageBucket:"infometro-cc.appspot.com",messagingSenderId:"358423331162"};firebase.initializeApp(config);var DB=firebase.database(),user_uid;firebase.auth().onAuthStateChanged(function(e){if(e){print("User is logined");var n=e.isAnonymous;print(n),n&&DB.ref("users/"+e.uid).once("value",function(e){e.val()||(初始化使用者資訊(),location_fn())}),user_uid=e.uid,"function"==typeof _is_login&&_is_login()}else print("User is not logined yet.");user_uid=e.uid});var provider=new firebase.auth.FacebookAuthProvider;