function 登出(){firebase.auth().signOut().then(function(){print("User sign out!"),window.location.href="/"},function(e){print("User sign out error!")})}function get_page(){return""==location.href.split("://")[1].split("/")[1]?"":"main"}function fb_login(e){firebase.auth().signInWithPopup(provider).then(function(n){var i=n.user;DB.ref("users/"+i.uid).once("value",function(n){n.val()?e():初始化使用者資訊(e)})}).catch(function(e){var n=(e.code,e.message,e.email),i=e.credential;"auth/account-exists-with-different-credential"===e.code&&firebase.auth().fetchProvidersForEmail(n).then(function(e){if("password"===e[0]){var t=prompt("請輸入email密碼與facebook帳戶綁定");firebase.auth().signInWithEmailAndPassword(n,t).then(function(e){e.link(i)}).then(function(){print("成功連結")})}})})}function anonymous_login(e){void 0!=user_uid&&e(),anonymous_fn=e,firebase.auth().signInAnonymously()}function 初始化使用者資訊(e,n){var i=firebase.auth().currentUser,t={name:i.displayName,url_name:"",photo:i.photoURL};"isAnonymous"==n&&(t.photo="https://semantic-ui.com/images/avatar/large/elliot.jpg",t.name="匿名"),DB.ref("users/"+i.uid).set(t).then(初始化藍圖資料(e))}function 初始化藍圖資料(e){var n=DB.ref("blueprint/"+user_uid).push(),i=[];i.push(line_json("橘線","#FF6900",!0)),i[i.length-1].metro.push(metro_json("總站")),n.set({name:"我的地鐵計畫",line:i}),"function"==typeof e&&e()}function blueprint_json(e){return{name:e,line:[]}}function set_line_root(e,n){DB.ref("info/"+e+"/root").set(n)}function line_json(e,n,i){var t=DB.ref("blueprint/"+user_uid).push().key;return set_line_root(t,user_uid+"(build)"),i||(i=!1),{_key:t,name:e,master:i,color:n,metro:[]}}function metro_json(e){return{_key:DB.ref("blueprint/"+user_uid).push().key,name:e,timestamp:firebase.database.ServerValue.TIMESTAMP}}function get_other_user(e,n){DB.ref("users/"+e).once("value",function(e){e.val()&&n(e.val())})}function blueprint_init(e){DB.ref("blueprint/"+user_uid).on("value",function(n){var i=[],t=vm.index_blueprint;if(n.forEach(function(e){i.push(e.val()),i[i.length-1].key=e.key}),0==i.length)return 初始化藍圖資料();vm.blueprint=i,t+1>=vm.blueprint.length&&($.cookie("index_blueprint","0"),t=0);for(var o=[],r=[],u=0;u<i.length;u++)if(o.push([]),r.push([]),i[u].line)for(var a=0;a<i[u].line.length;a++)o[u].push([]),r[u].push([]),o[u][o[u].length-1].check=!1,r[u][o[u].length-1].check=!1;$.extend(o,vm.index),vm.index=o,vm.blueprint[t].line.length!=vm.index[t].length&&(vm.index[t]=r[t],print("重新設定index[全部]"));var s=vm.action;if("new_blueprint"==s){var l=vm.index.length-1;vm.exchange_blueprint(l,!0)}else"new_line"==s?(vm.index_update(),vm.exchange_line(vm.index[t].length-1)):"swap_list"==s?vm.index_update():"delete_blueprint"==s?(vm.index_update(),vm.exchange_blueprint(t,!0)):"load"==s&&vm.exchange_blueprint(t,!0);"function"==typeof e&&setTimeout(e,5),vm.action="",vm.blueprint=i})}function _is_login(){DB.ref("users/"+user_uid).once("value",function(e){e.val()?vm.users=e.val():初始化使用者資訊()}),DB.ref("users_data/"+user_uid).once("value",function(e){e.val()&&e.val().index&&(vm.index=e.val().index,delete e.val().index)}).then(function(){void 0!=$.cookie("index_blueprint")&&(vm.index_blueprint=$.cookie("index_blueprint")),blueprint_init(function(){$(".blueprint_list").dropdown("destroy").dropdown({on:"customClick",onShow:function(){sortable.blueprint.option("disabled",!0)},onHide:function(){sortable.blueprint.option("disabled",!1)}}),sortable.blueprint||(sortable.blueprint=new Sortable(id("blueprint_drag"),{animation:150,forceFallback:!1}))})})}var config={apiKey:"AIzaSyAalJEx21SpnVU5q5lW0eTSVPTz18s2Hy8",authDomain:"infometro-cc.firebaseapp.com",databaseURL:"https://infometro-cc.firebaseio.com",storageBucket:"infometro-cc.appspot.com",messagingSenderId:"358423331162"};firebase.initializeApp(config);var DB=firebase.database(),user_uid;firebase.auth().onAuthStateChanged(function(e){e?(user_uid=e.uid,e.isAnonymous?DB.ref("users/"+e.uid).once("value",function(e){if(e.val())"main"==get_page()&&_is_login();else{var n=_is_login;"function"==typeof anonymous_fn&&(n=anonymous_fn),初始化使用者資訊(n,"isAnonymous")}}):"main"==get_page()&&_is_login()):(print("User is not logined yet."),"main"==get_page()&&location.replace("/"))});var provider=new firebase.auth.FacebookAuthProvider,anonymous_fn;