var vm=new Vue({el:"#main",data:{blueprint:[],index:[],index_blueprint:0,index_line:0,info_active:"",key_metro:"",action:"load",info:[],users:[],mode:1,pick_master:void 0,pick_color:void 0,url_info:void 0,filter_search:"",is_nav:!1},mounted:function(){$("#main").css("visibility","visible")},updated:function(){setTimeout(function(){$(window).resize()},0),$("#board_info .ui.active").show()},firebase:{},computed:{master_line_color:function(){return 0==this.blueprint.length?"":this.pick_color&&this.pick_master?this.pick_color:this.get_blueprint().line[0].color},line:function(){return 0==this.blueprint.length?"":this.get_blueprint().line},line_name:function(){return 0==this.blueprint.length?"":this.get_line().name},line_color:function(e){return 0==this.blueprint.length?"":this.pick_color&&!this.pick_master?this.pick_color:this.get_line().color},metro:function(){if(0==this.blueprint.length)return"";var e=this.get_line();return void 0==e&&vm.exchange_line(0),e.metro},metro_name:function(){return 0==this.blueprint.length?"":this.get_metro().name},metro_create:function(){if(0==this.blueprint.length)return"";var e=this.get_metro().timestamp;return void 0==e?"":moment(e).format("lll")},info_count:function(){return 0==this.blueprint.length?"":this.info.length},info_favorites:function(){var e=this.info.filter(function(e){return!!e.favorite&&!!e.url_info});return 0!=e.length&&e},info_sort_filter:function(){var e=this.info;return e=e.sort(function(e,i){return e.update_timestamp>i.update_timestamp?1:-1}),e=e.sort(function(e,i){return e.favorite?-1:1}),e.filter(function(e){return e.message.indexOf(vm.filter_search)>-1})}},filters:{message_filter:function(e){return e=e.replace(/\</g,"&lt;"),e=e.replace(/\>/g,"&gt;"),e=urlify(e),e=e.replace(/(?:\r\n|\r|\n)/g,"<br/>"),e=e.replace(/ /g,"&nbsp;"),e=e.replace(/\<a&nbsp;href=/g,"<a href="),setTimeout(function(){$("#board_info .info_message").find("a").css("color",vm.line_color).attr("target","_blank")},5),e}},watch:{info_active:function(){var e=this.get_index_line();e.info_active||(e.info_active=[]),e.info_active[vm.key_metro]=this.info_active||"",vm.index_update()},key_metro:function(){var e=DB.ref("info/"+vm.get_line_key()+"/metro/"+vm.key_metro).orderByChild("update_timestamp");vm.$bindAsArray("info",e);var i=this.get_index_line();if(i.key_metro=this.key_metro,i.info_active){var t=i.info_active[this.key_metro];this.info_active=t}else vm.index_update();vm.leave_edit_info(),e.on("child_added",function(e){setTimeout(function(){$("#board_info .dropdown").dropdown("destroy").dropdown()},5)})}},methods:{get_youtube_embed:function(e){return e.url_info&&e.url_info.youtube?(setTimeout(function(){$("#"+e[".key"]).find(".ui.embed:not(.active)").embed()},5),"flex-direction: column"):""},get_favorite_style:function(e,i){return e?{color:i}:{}},is_master:function(){return 0==this.blueprint.length?"":0==vm.index_line},color_gradient:function(e){return"linear-gradient(to right, #000 50%, "+e+" 0%)"},mode_txt:function(){if(sortable.blueprint)return 0==this.mode?(setTimeout(function(){sortable.metro.option("disabled",!0)},5),"一般模式"):1==this.mode?(setTimeout(function(){sortable.metro.option("disabled",!1)},5),"編輯模式"):1.5==this.mode?"編輯模式":void 0},mode_click:function(){var e=this.mode;e=Math.floor(e+1),e>1&&(e=0),this.mode=e},mode_class:function(){return 0==this.mode?"male":1==this.mode?"configure":1.5==this.mode?"trash":void 0},index_update:function(){var e=JSON.parse(JSON.stringify(vm.index));setTimeout(function(){DB.ref("users_data/"+user_uid+"/index").set(e)},0)},"更新藍圖":function(e,i){void 0!=e&&void 0!=i||(i=vm.get_blueprint(),e=i.key),setTimeout(function(){DB.ref("blueprint/"+user_uid+"/"+e).set(i)},0)},get_blueprint:function(e){return void 0!=e?this.blueprint[e]:this.blueprint[this.index_blueprint]},get_index_blueprint:function(){return vm.index[vm.index_blueprint]},get_line:function(){return this.get_blueprint().line[this.index_line]},get_index_line:function(){return vm.index[vm.index_blueprint][vm.index_line]},update_index_line:function(e){for(var i=0,t=0;t<e.length;t++)if(e[t]||(e[t]=[],e[t].check=!1),e[t].check){i=t;break}vm.index_line=i},update_index_line_check:function(){for(var e=vm.get_index_blueprint(),i=0;i<e.length;i++)e[i]||(e[i]=[]),e[i].check=!1;e[vm.index_line].check=!0},update_selection_color:function(){var e=vm.line_color;if(!document.getElementById("selection")){var i=document.createElement("style");i.id="selection",i.type="text/css",document.getElementsByTagName("head")[0].appendChild(i)}document.getElementById("selection").innerHTML="::selection {background: "+e+";color: #fff;}::-moz-selection {background: "+e+";color: #fff;}img::selection {background: "+e+";color: #fff;}img::-moz-selection {background: "+e+";color: #fff;}"},update_metro_key:function(e){var i=this.get_line().metro,t=!1;if(e.key_metro){for(var n=0;n<i.length;n++)if(i[n]._key==e.key_metro){vm.key_metro=i[n]._key,t=!0;break}t||(vm.key_metro=i[0]._key)}else vm.key_metro=i[0]._key},new_blueprint:function(){if("load"!=vm.action){vm.action="new_blueprint";var e=DB.ref("blueprint/"+user_uid).push(),i=[];i.push(line_json("橘線","#FF6900",!0)),i[i.length-1].metro.push(metro_json("總站")),e.set({name:"我的地鐵計畫",line:i})}},delete_blueprint:function(e){$(".ui.modal").modal("refresh"),setTimeout(function(){$("#blueprint_delete_modal").modal({inverted:!0,closable:!1}).modal("show")}),$("#blueprint_delete_name").html(vm.get_blueprint().name),$("#blueprint_delete_button").off("dblclick").on("dblclick",function(){for(var i,t=0;t<vm.blueprint.length;t++)if(vm.blueprint[t].key==e){i=t;break}vm.action="delete_blueprint";for(var n=vm.blueprint[i].line,t=0;t<n.length;t++)vm.delete_info_line(n[t]._key);vm.blueprint.length>1?(vm.index.splice(i,1),vm.index_update(),vm.index_line=0,vm.index_blueprint=0,vm.update_index_line(vm.index[vm.index_blueprint]),vm.update_index_line_check(),vm.update_selection_color(),setTimeout(function(){vm.update_metro_key(vm.index[vm.index_blueprint][vm.index_line])},0),DB.ref("blueprint/"+user_uid+"/"+e).remove()):DB.ref("blueprint/"+user_uid+"/"+e).remove().then(function(){vm.index.splice(i,1),vm.index_update(),location.reload()}),$("#blueprint_delete_button").off("click"),$("#blueprint_delete_modal").modal("hide")})},"檢查更新錯誤索引":function(e,i){if(i[e]&&i[e].line.length!=vm.index[e].length){for(var t=i[e].line,n=(vm.index[e],[]),o=0;o<t.length;o++)void 0!=vm.index[e][o]?n.push(vm.index[e][o]):(n.push({check:!1}),n[n.length-1].check=!1);print("重新更新索引"),vm.index[e]=n}},exchange_blueprint:function(e,i,t){"load"!=vm.action&&vm.index_blueprint==e||t&&$(t.target).hasClass("blueprint_i")||(vm.檢查更新錯誤索引(e,vm.blueprint),e>=vm.blueprint.length&&(e=0),$("#top_tag").stop().fadeOut(0),$.cookie("index_blueprint",e),t&&t.target&&void 0!=t.target.className&&(t.target.className.indexOf("blueprint_a")>-1||t.target.className.indexOf("blueprint_i")>-1)&&(i=!0),i&&(vm.index_blueprint=e,vm.update_index_line(vm.index[e]),vm.update_index_line_check(),vm.update_selection_color(),vm.update_metro_key(vm.index[e][vm.index_line])),setTimeout(move_center,0))},exchange_line:function(e){function i(){vm.index_line=e,vm.get_index_blueprint()[e]||vm.replace_index(),vm.update_index_line_check(),vm.update_selection_color(),vm.update_metro_key(vm.get_index_blueprint()[e]),setTimeout(move_center,0)}if(vm.index_line!=e){if($("#top_tag").stop().fadeOut(0),$("html").hasClass("re_name"))return setTimeout(function(){i()},0);i()}},replace_index:function(){for(var e=vm.get_blueprint().line,i=vm.get_index_blueprint(),t=e.length-i.length,n=0;n<t;n++)i.push([]);print("重新設定了index")},new_line:function(){if("load"!=vm.action){var e=this.get_blueprint(),i=vm.get_index_blueprint();e.line||(e.line=[]);var t=vm.get_default_color(e.line.length),n=line_json("未命名",t);n.metro.push(metro_json("總站")),e.line.push(n),i.push({check:!1}),vm.action="new_line",vm.更新藍圖(e.key,e)}},find_line_index:function(e,i){for(var t=0;t<i.line.length;t++)if(i.line[t]._key==e)return t},move_line:function(e){var i=vm.get_blueprint(),t=vm.find_line_index(e,i);if(void 0!=t){var n=i.line.splice(t,1);if(vm.get_index_blueprint().splice(t,1),vm.index_line>=t){var o=vm.index_line-1;o<0&&(o=0),vm.index_line=o}return vm.update_metro_key(vm.get_index_line()),vm.action="move_line",vm.更新藍圖(i.key,i),n}},delete_line:function(e){var i=vm.get_blueprint(),t=vm.find_line_index(e,i);if(void 0!=t){$(".ui.modal").modal("refresh"),setTimeout(function(){$("#line_delete_modal").modal({inverted:!0,closable:!1}).modal("show")},0);var n=i.line[t].color;$("#line_delete_modal").css("borderTopColor",n),$("#line_delete_button").css("backgroundColor",n),$("#line_delete_button").off("click").on("click",function(){if(i.line.splice(t,1),vm.get_index_blueprint().splice(t,1),vm.index_line>=t){var n=vm.index_line-1;n<0&&(n=0),vm.index_line=n}vm.update_metro_key(vm.get_index_line()),vm.action="delete_list",vm.更新藍圖(i.key,i),vm.delete_info_line(e),$("#line_delete_button").off("click"),$("#line_delete_modal").modal("hide")})}},get_line_key:function(){return vm.get_line()._key},new_metro:function(e){var i=metro_json("未命名"),t=JSON.parse(JSON.stringify(this.get_blueprint()));t.line[vm.index_line].metro.splice(e,0,i),vm.action="new_metro",this.更新藍圖(t.key,t),setTimeout(move_center,0)},check_metro:function(e){if(vm.key_metro==e){return"background-color: "+this.get_line().color}},exchange_metro:function(e){this.key_metro=e},find_metro_index:function(e,i){for(var t=i.line[this.index_line].metro,n=0;n<t.length;n++)if(t[n]._key==e)return n},move_metro:function(e,i){var t=this.get_blueprint();if(!(t.line[this.index_line].metro.length<=1)){var n=vm.find_metro_index(e,t);if(void 0!=n){var o=t.line[this.index_line].metro.splice(n,1);if(this.key_metro==e){var r=n-1;r<0&&(r=0);var l=t.line[this.index_line].metro[r]._key;this.key_metro=l}return DB.ref("info/"+t.line[this.index_line]._key+"/metro").child(e).once("value",function(n){DB.ref("info/"+vm.get_blueprint().line[i]._key+"/metro/"+e).set(n.val()),DB.ref("info/"+t.line[vm.index_line]._key+"/metro").child(e).remove()}),o}}},delete_metro:function(e){var i=JSON.parse(JSON.stringify(this.get_blueprint()));if(!(i.line[this.index_line].metro.length<=1)){var t=vm.find_metro_index(e,i);if(void 0!=t){if(i.line[this.index_line].metro.splice(t,1),this.key_metro==e){var n=t-1;n<0&&(n=0);var o=i.line[this.index_line].metro[n]._key;this.key_metro=o}vm.action="delete_metro",this.更新藍圖(i.key,i),DB.ref("info/"+i.line[this.index_line]._key+"/metro").child(e).remove()}}},get_metro:function(){for(var e=this.get_line(),i=vm.key_metro,t=(e.metro,0),n=0;n<e.metro.length;n++)if(e.metro[n]._key==i){t=n;break}return e.metro[t]},new_info:function(){var e=$.trim($("#board_textarea").val());if(""!=e){var i={message:e,favorite:!1,url_info:"",update_timestamp:firebase.database.ServerValue.TIMESTAMP,timestamp:firebase.database.ServerValue.TIMESTAMP,users:user_uid};vm.url_info&&(i.url_info=vm.url_info),vm.url_info=void 0,$("#board_textarea").val("").keyup(),DB.ref("info/"+vm.get_line_key()+"/metro/"+vm.key_metro).push(i,function(e){e&&e.toString().indexOf("Permission denied")>-1&&(set_line_root(vm.get_line_key(),user_uid+"(build)"),setTimeout(function(){print("未發現root，重新寫入root"),location.reload()},0))})}},delete_info:function(e,i){var t=$(i.target).closest(".board_list");t.hasClass("edit")||($delete_info=t.find("._delete_info"),$delete_info.dimmer({duration:{show:400,hide:0}}).dimmer("show"),$delete_info.find(".send").off("click").on("click",function(){DB.ref("info/"+vm.get_line_key()+"/metro/"+vm.key_metro).child(e).remove(),$delete_info.dimmer("hide")}),$delete_info.find(".cancel").off("click").on("click",function(){$delete_info.dimmer("hide")}))},delete_info_line:function(e){DB.ref("info/"+e+"/metro").remove(),DB.ref("info/"+e+"/root").remove()},favorite_info:function(e){DB.ref("info/"+vm.get_line_key()+"/metro/"+vm.key_metro).child(e[".key"]).update({favorite:!e.favorite,update_timestamp:firebase.database.ServerValue.TIMESTAMP})},edit_info:function(e,i,t){var n=$(t.target).closest(".board_list");if("dbl"==i){if(1!=vm.mode)return;if(n.hasClass("edit"))return}$("html").addClass("re_name");var o=e[".key"];n.addClass("edit");var r=n.find("textarea");r.val(e.message).focus(),$(document.body).on("keyup.textarea",function(e){27==e.keyCode&&vm.leave_edit_info(n)}),r.off("paste").on("paste",function(){e.url_info||textarea_paste2(r[0],e)}),n.find("button.send").one("click",function(){e.url_info||(e.url_info="");var i=$.trim(r.val());vm.leave_edit_info(n),r.off("paste"),DB.ref("info/"+vm.get_line_key()+"/metro/"+vm.key_metro).child(o).update({message:i,url_info:e.url_info,update_timestamp:firebase.database.ServerValue.TIMESTAMP})}),n.find("button.cancel").one("click",function(){vm.leave_edit_info(n),r.off("paste")})},leave_edit_info:function(e){$(".board_list").hasClass("edit")&&($(document).one("click",function(){$("html").removeClass("re_name")}),e?e.removeClass("edit"):$(".board_list").removeClass("edit"),$(document.body).off("keyup.textarea"))},re_name:function(e,i,t){function n(){return"blueprint"==i?vm.blueprint[e]:"line"==i?vm.get_blueprint().line[e]:"metro"==i?vm.get_line().metro[e]:void 0}function o(){$(document).one("click",function(){$("html").removeClass("re_name")}),r.removeClass("edit"),sortable[i]&&sortable[i].option("disabled",!1),_.off("keyup."+i+"_input"),$(document).off("click."+i+"_input")}if(!$(t.target).hasClass("blueprint_i")){$("html").addClass("re_name");var r=$(t.target).closest("."+i+"_list");r.addClass("edit"),sortable[i]&&sortable[i].option("disabled",!0);var l=n().name,_=r.find("."+i+"_input");_.select().on("keyup."+i+"_input",function(e){13==e.which?(o(),vm.action="re_name",vm.更新藍圖()):27==e.which&&(o(),n().name=l)}),setTimeout(function(){$(document).on("click."+i+"_input",function(e){e.target.className.indexOf(i+"_input")==-1&&(o(),n().name=l)})},5)}},get_default_color:function(e){var i=["#f2711c","#db2828","#fbbd08","#b5cc18","#21ba45","#00b5ad","#2185d0","#5829bb","#a333c8","#e03997","#a5673f","#767676"][e];return i?i:"#000000"},open_color:function(e,i,t){i=i.split("#")[1];var n=$(event.target),o=n.offset().left,r=n.offset().top+n.height()+2;vm.pick_master=t,$("#left_color").css({left:o,top:r}).colpickSetColor(i).colpickShow(),$(".colpick_submit").off("click.op").on("click.op",function(){vm.get_blueprint().line[e].color="#"+$("#left_color").val(),vm.action="open_color",vm.更新藍圖(),$(this).off("click.op")})},swap_blueprint:function(e,i){},swap_list:function(e,i){function t(e){for(var i=0;i<n.line.length;i++)if(n.line[i]._key==e)return i}if(e!=i){var n=JSON.parse(JSON.stringify(this.get_blueprint())),o=[],r=[];$("#line_drag li").each(function(){var e=t($(this).data("key"));o.push(n.line[e]),r.push(vm.index[vm.index_blueprint][e])}),n.line=o,vm.index[vm.index_blueprint]=r,vm.update_index_line(r),vm.action="swap_list",vm.更新藍圖(n.key,n)}},swap_metro:function(e,i){function t(e){for(var i=0;i<o.length;i++)if(o[i]._key==e)return i}if(e!=i){var n=JSON.parse(JSON.stringify(this.get_blueprint())),o=n.line[this.index_line].metro,r=[];$("#top_tag li").each(function(){var e=t($(this).data("key"));r.push(o[e])}),n.line[this.index_line].metro=r,vm.action="swap_metro",vm.更新藍圖(n.key,n)}}}});